---
title: Eight schools excercise with Greta
author: Taavi Päll
date: '2018-05-02'
slug: eight-schools-excercise-with-greta
categories:
  - Bayes
tags:
  - mcmc
  - bayes
  - greta
  - tensorflow
description: ''
topics: []
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/viz/viz.js"></script>
<link href="/rmarkdown-libs/DiagrammeR-styles/styles.css" rel="stylesheet" />
<script src="/rmarkdown-libs/grViz-binding/grViz.js"></script>


<p>First time I encountered Greta on Twitter:</p>
<blockquote class="twitter-tweet" data-lang="en">
<p lang="en" dir="ltr">
Here's the latest post from RViews “An Introduction to Greta” <a href="https://t.co/g1uMNsMWCh">https://t.co/g1uMNsMWCh</a>
</p>
— RStudio (<span class="citation">@rstudio</span>) <a href="https://twitter.com/rstudio/status/988466672779583488?ref_src=twsrc%5Etfw">April 23, 2018</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>I fell in love from the first sight. I like the beauty. I think it’s the expressiveness. I followed the first link in “An Introduction to Greta” by Joseph Rickert to <code>greta</code> <a href="https://greta-dev.github.io/greta/">webpage</a>.</p>
<p>After installation and pasting in <a href="https://greta-dev.github.io/greta/get_started.html">get_started</a> code I wanted to explore Greta on my own. Nothing too dangerous. Eight schools seemed like a good topic for the first date. Eight schools is very well covered in Bayes/Stan blogs - <a href="http://andrewgelman.com/2014/01/21/everything-need-know-bayesian-statistics-learned-eight-schools/">everything-need-know-bayesian-statistics-learned-eight-schools</a>, <a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started">RStan-Getting-Started</a>, <a href="http://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html">divergences_and_bias</a>, so my intellectual input would be very small and is limited only to translating Stan code to Greta.</p>
<p>Let’s get started! I assume that you have installed <code>greta</code> and its dependency <a href="https://greta-dev.github.io/greta/get_started.html#installation">tensorflow</a> by now.</p>
<pre class="r"><code>library(greta)</code></pre>
<pre><code>## 
## Attaching package: &#39;greta&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     binomial, poisson</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     %*%, backsolve, beta, colMeans, colSums, diag, forwardsolve,
##     gamma, rowMeans, rowSums, sweep</code></pre>
<div id="data" class="section level2">
<h2>Data</h2>
<p><em>Eight schools</em> dataset is nice and small with estimated treatment effect <strong>y</strong> and its standard deviation <strong>sigma</strong> of Scholastic Aptitude Test (SAT) scores for 8 schools:</p>
<pre class="r"><code>y &lt;- c(28,  8, -3,  7, -1,  1, 18, 12)
sigma &lt;- c(15, 10, 16, 11,  9, 11, 10, 18)</code></pre>
<p>To use these two vectors as data in a greta model we need to convert them to greta arrays:</p>
<pre class="r"><code>y &lt;- as_data(y)
sigma &lt;- as_data(sigma)</code></pre>
</div>
<div id="model" class="section level2">
<h2>Model</h2>
<p><a href="http://www.stat.columbia.edu/~gelman/research/published/tau9.pdf">This is two-level normal model</a> of data <strong>y_ij</strong> with group-level effects <strong>alpha_j</strong> .</p>
<p><span class="math display">\[y_{ij} \sim N(\mu + \alpha_j, \sigma_y)\]</span> <em>i=1,…,n_j</em>, <em>j=1,…,J</em><br />
<span class="math display">\[\alpha_j \sim N(0, \sigma_\alpha)\]</span> <em>j=1,…,J</em></p>
<p>We are going to use more efficient <a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started">parametrisation</a>, where alpha_j is represented as product of two new parameters <strong>tau</strong> and <strong>eta</strong>:</p>
<p><span class="math display">\[y_{ij} \sim N(\mu + \tau \times \eta_j, \sigma_y)\]</span> <em>i=1,…,n_j</em>, <em>j=1,…,J</em><br />
<span class="math display">\[\eta_j \sim N(0, \sigma_eta)\]</span> <em>j=1,…,J</em></p>
<p>(sorry for ugly math..)</p>
</div>
<div id="priors" class="section level2">
<h2>Priors</h2>
<p>Based on these latter formula, we define variables and priors by creating greta arrays to represent the parameters in our model.</p>
<p><strong>mu</strong> comes from normal distribution. <strong>tau</strong> comes from half-cauchy (only positive values are allowed and therefore distribution is truncated at zero), and <strong>eta</strong> comes again from normal distribution, but we specify different eta for each of the eight schools:</p>
<pre class="r"><code>mu  &lt;- normal(0, 5)
tau &lt;- cauchy(0, 5, truncation = c(0, Inf))
eta &lt;- normal(0, 1, dim = 8)</code></pre>
</div>
<div id="operations" class="section level2">
<h2>Operations</h2>
<p>Here we specify operations in greta notation (transformed parameters in stan) to combine our parameters using mathematical operators:</p>
<pre class="r"><code>theta &lt;- mu + tau * eta</code></pre>
</div>
<div id="likelihood" class="section level2">
<h2>Likelihood</h2>
<p>To perform statistical inference on this model, we need to link it to our observed dependent data. We define a likelihood for the observed estimated treatment effects <code>y</code>.</p>
<p>Likelihood distribution is specified like so:</p>
<pre class="r"><code>distribution(y) &lt;- normal(theta, sigma)</code></pre>
</div>
<div id="collect-parameters-to-model-object" class="section level2">
<h2>Collect parameters to model object</h2>
<p>Now that we have define priors and likelihood, we need to put everything together into greta model that we are going to use for sampling:</p>
<pre class="r"><code>m &lt;- model(mu, tau, eta, theta)</code></pre>
<p>We can plot out nice <a href="https://greta-dev.github.io/greta/get_started.html#plotting">model graph</a>. We have prior parameters/data for probability distributions (squares and rhombs), model parameters (rings) connected by deterministic (solid arrow) or stochastic (dashed arrow) links:</p>
<pre class="r"><code>library(DiagrammeR)
gr &lt;- plot(m)
render_graph(gr)</code></pre>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\",\n       rankdir = \"LR\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"true\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"gray50\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"mu\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#E0D2EE\", width = \"0.6\", height = \"0.48\", fillcolor = \"#F4F0F9\"] \n  \"2\" [label = \"normal\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"diamond\", color = \"#B797D7\", width = \"1\", height = \"0.8\", fillcolor = \"#E0D2EE\"] \n  \"3\" [label = \"0\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"4\" [label = \"5\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"5\" [label = \"theta\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"lightgray\", width = \"0.2\", height = \"0.16\", fillcolor = \"#D3D3D3\"] \n  \"6\" [label = \"normal\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"diamond\", color = \"#B797D7\", width = \"1\", height = \"0.8\", fillcolor = \"#E0D2EE\"] \n  \"7\" [label = \"sigma\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"8\" [label = \"y\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"9\" [label = \"\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"lightgray\", width = \"0.2\", height = \"0.16\", fillcolor = \"#D3D3D3\"] \n  \"10\" [label = \"tau\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#E0D2EE\", width = \"0.6\", height = \"0.48\", fillcolor = \"#F4F0F9\"] \n  \"11\" [label = \"cauchy\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"diamond\", color = \"#B797D7\", width = \"1\", height = \"0.8\", fillcolor = \"#E0D2EE\"] \n  \"12\" [label = \"0\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"13\" [label = \"5\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"14\" [label = \"eta\n\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"circle\", color = \"#E0D2EE\", width = \"0.6\", height = \"0.48\", fillcolor = \"#F4F0F9\"] \n  \"15\" [label = \"normal\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"diamond\", color = \"#B797D7\", width = \"1\", height = \"0.8\", fillcolor = \"#E0D2EE\"] \n  \"16\" [label = \"0\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n  \"17\" [label = \"1\", fontcolor = \"#8960B3\", fontsize = \"12\", penwidth = \"2\", shape = \"square\", color = \"#E0D2EE\", width = \"0.5\", height = \"0.4\", fillcolor = \"#FFFFFF\"] \n\"1\"->\"5\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"add\", style = \"solid\"] \n\"2\"->\"1\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", penwidth = \"3\", style = \"dashed\"] \n\"3\"->\"2\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"mean\", style = \"solid\"] \n\"4\"->\"2\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"sd\", style = \"solid\"] \n\"5\"->\"6\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"mean\", style = \"solid\"] \n\"6\"->\"8\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", penwidth = \"3\", style = \"dashed\"] \n\"7\"->\"6\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"sd\", style = \"solid\"] \n\"9\"->\"5\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"add\", style = \"solid\"] \n\"10\"->\"9\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"multiply\", style = \"solid\"] \n\"11\"->\"10\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", penwidth = \"3\", style = \"dashed\"] \n\"12\"->\"11\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"location\", style = \"solid\"] \n\"13\"->\"11\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"scale\", style = \"solid\"] \n\"14\"->\"9\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"multiply\", style = \"solid\"] \n\"15\"->\"14\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", penwidth = \"3\", style = \"dashed\"] \n\"16\"->\"15\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"mean\", style = \"solid\"] \n\"17\"->\"15\" [color = \"Gainsboro\", fontname = \"Helvetica\", fontcolor = \"gray\", fontsize = \"11\", penwidth = \"3\", label = \"sd\", style = \"solid\"] \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="sampling" class="section level2">
<h2>Sampling</h2>
<p>We have a greta model that will give us the joint density for a candidate set of values, so we can use that to carry out inference on the model. Here we’re using 1000 steps of the Hamiltonian Monte Carlo (HMC) algorithm, by default sampler uses 100 steps for warmup.</p>
<pre class="r"><code>draws &lt;- mcmc(m, n_samples = 1000)</code></pre>
<p><code>draws</code> is an mcmc.list object, from the <code>coda</code> R package. So, it’s possible to use any function that recognises this class of object.</p>
<pre class="r"><code>summary(draws)</code></pre>
<pre><code>## 
## Iterations = 1:1000
## Thinning interval = 1 
## Number of chains = 1 
## Sample size per chain = 1000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##            Mean     SD Naive SE Time-series SE
## mu      4.32650 3.4777  0.10997        0.04790
## tau     3.55602 2.9950  0.09471        0.07615
## eta1    0.31449 0.9822  0.03106        0.02341
## eta2    0.12574 0.9604  0.03037        0.01354
## eta3   -0.07218 0.9597  0.03035        0.01899
## eta4    0.06650 0.9700  0.03068        0.01303
## eta5   -0.14850 0.9450  0.02988        0.01341
## eta6   -0.08699 0.9711  0.03071        0.01660
## eta7    0.36703 0.9680  0.03061        0.02050
## eta8    0.03155 0.9747  0.03082        0.04845
## theta1  6.02775 5.6263  0.17792        0.13331
## theta2  4.73805 4.6828  0.14808        0.08829
## theta3  3.87346 5.0487  0.15965        0.11534
## theta4  4.67178 4.7475  0.15013        0.09697
## theta5  3.60640 4.8344  0.15288        0.10392
## theta6  3.99449 5.0303  0.15907        0.10876
## theta7  6.15284 5.1723  0.16356        0.11922
## theta8  4.60295 5.2956  0.16746        0.18187
## 
## 2. Quantiles for each variable:
## 
##           2.5%     25%      50%    75%  97.5%
## mu     -2.1641  1.7856  4.47045 6.8289 11.031
## tau     0.1332  1.3602  2.80674 5.1343 10.875
## eta1   -1.6118 -0.3385  0.32551 0.9863  2.127
## eta2   -1.7730 -0.5492  0.12355 0.8171  1.932
## eta3   -1.8823 -0.7486 -0.07803 0.5614  1.774
## eta4   -1.9129 -0.5558  0.05469 0.6975  1.975
## eta5   -1.9646 -0.8133 -0.11725 0.4426  1.757
## eta6   -1.9461 -0.7379 -0.09740 0.5760  1.808
## eta7   -1.6421 -0.2865  0.39259 1.0271  2.133
## eta8   -1.9361 -0.6151  0.02038 0.7209  1.906
## theta1 -3.3524  2.3628  5.76095 8.8553 19.643
## theta2 -5.0904  1.7328  4.73065 7.7571 13.697
## theta3 -6.9793  0.7465  4.06884 7.0281 13.299
## theta4 -4.9009  1.6609  4.76036 7.4958 13.909
## theta5 -6.6298  0.7306  3.83300 6.6707 12.760
## theta6 -6.8794  0.8346  4.13003 7.0634 13.776
## theta7 -2.4360  2.5638  5.66612 9.3349 17.704
## theta8 -5.5710  1.3723  4.52083 7.6786 14.596</code></pre>
<p>MCMC chain and the parameter estimates can be plotted using <code>bayesplot</code> package:</p>
<pre class="r"><code>library(bayesplot)</code></pre>
<pre><code>## This is bayesplot version 1.4.0</code></pre>
<pre><code>## - Plotting theme set to bayesplot::theme_default()</code></pre>
<pre><code>## - Online documentation at mc-stan.org/bayesplot</code></pre>
<pre class="r"><code>mcmc_trace(draws)</code></pre>
<p><img src="/post/2018-05-02-eight-schools-excercise-with-greta_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>mcmc_intervals(draws)</code></pre>
<p><img src="/post/2018-05-02-eight-schools-excercise-with-greta_files/figure-html/unnamed-chunk-11-2.png" width="672" /></p>
</div>
